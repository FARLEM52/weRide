# WeRide ‚Äî backend –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫ –≤ —Ç–∞–∫—Å–∏

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  HTTP :8080  ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ  API Gateway ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ gRPC
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚ñº                ‚ñº                  ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ User Service ‚îÇ ‚îÇ Room Service ‚îÇ ‚îÇ Payment Service  ‚îÇ
  ‚îÇ   :50052     ‚îÇ ‚îÇ   :50051     ‚îÇ ‚îÇ     :50053       ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ SQL
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  PostgreSQL  ‚îÇ
                    ‚îÇ  3 databases ‚îÇ
                    ‚îÇ  :5432       ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
cp .env.example .env 2>/dev/null || true
# –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ÆKassa credentials payment_service –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –≤ mock-—Ä–µ–∂–∏–º–µ
docker compose up --build
```

API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8080` (—á–µ—Ä–µ–∑ API Gateway).

---

## API Reference

### Auth
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| POST | `/auth/register` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è |
| POST | `/auth/login` | –í—Ö–æ–¥, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JWT |
| GET  | `/auth/history` | üîí –ò—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫ |

### Rooms
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| POST | `/rooms` | üîí –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É |
| GET  | `/rooms` | üîí –ù–∞–π—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ |
| GET  | `/rooms/:id` | üîí –î–µ—Ç–∞–ª–∏ –∫–æ–º–Ω–∞—Ç—ã |
| POST | `/rooms/:id/join` | üîí –í—Å—Ç—É–ø–∏—Ç—å |
| POST | `/rooms/:id/exit` | üîí –ü–æ–∫–∏–Ω—É—Ç—å |
| POST | `/rooms/:id/complete` | üîí –ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É (—Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –æ–ø–ª–∞—Ç—É) |

### Payments
| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| POST | `/payments/process` | üîí –°–ø–∏—Å–∞—Ç—å –æ–ø–ª–∞—Ç—É |
| POST | `/payments/refund` | üîí –í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ |
| GET  | `/payments/history` | üîí –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |

üîí ‚Äî —Ç—Ä–µ–±—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <JWT>`

---

## –§–ª–æ—É –ø–æ–µ–∑–¥–∫–∏

```
1. POST /auth/register + POST /auth/login  ‚Üí –ø–æ–ª—É—á–∞–µ–º JWT
2. POST /rooms                             ‚Üí –≤–æ–¥–∏—Ç–µ–ª—å —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É
3. POST /rooms/:id/join                    ‚Üí –ø–∞—Å—Å–∞–∂–∏—Ä—ã –≤—Å—Ç—É–ø–∞—é—Ç
4. POST /rooms/:id/complete                ‚Üí –≤–æ–¥–∏—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–æ–µ–∑–¥–∫—É
   ‚îî‚îÄ‚îÄ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
       ‚îú‚îÄ‚îÄ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–∞—Ä—à—Ä—É—Ç –≤ user_service
       ‚îî‚îÄ‚îÄ —Å–ø–∏—Å—ã–≤–∞–µ—Ç cost_per_member —Å –∫–∞–∂–¥–æ–≥–æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞ —á–µ—Ä–µ–∑ –ÆKassa
5. GET  /payments/history                  ‚Üí –ø–∞—Å—Å–∞–∂–∏—Ä –≤–∏–¥–∏—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
6. GET  /auth/history                      ‚Üí –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫
```

---

## –ÆKassa

–ü–æ–ª—É—á–∏—Ç—å credentials: https://yookassa.ru/my/api-keys

–í `.env`:
```
YOOKASSA_SHOP_ID=–≤–∞—à_shop_id
YOOKASSA_SECRET_KEY=–≤–∞—à_secret_key
```

---

## CI/CD

–ü–∞–π–ø–ª–∞–π–Ω –≤ `.gitlab-ci.yml`:

```
lint ‚Üí test ‚Üí build ‚Üí push ‚Üí deploy (manual)
```

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ GitLab (Settings ‚Üí CI/CD ‚Üí Variables):
- `JWT_SECRET`
- `YOOKASSA_SHOP_ID`
- `YOOKASSA_SECRET_KEY`
- `DEPLOY_HOST` ‚Äî IP —Å–µ—Ä–≤–µ—Ä–∞
- `DEPLOY_USER` ‚Äî SSH –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `DEPLOY_SSH_KEY` ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á (masked)
